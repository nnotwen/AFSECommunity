name: Discord Notifications

on:
 issues:
  types: [opened, closed, reopened]
 pull_request:
  types: [opened, closed, reopened, review_requested]
 watch:
  types: [started]
 fork:
 create:

jobs:
 discord:
  runs-on: ubuntu-latest
  steps:
   - name: Validate Discord Webhook Secret
     run: |
      if [ -z "${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}" ]; then
        echo "❌ Discord webhook URL is not set!"
        echo "Add GH_NOTIFICATIONS_WEBHOOK_URL secret in repository settings"
        exit 1
      fi
      echo "✅ Discord webhook secret is configured"

   - name: Handle Issues
     if: github.event_name == 'issues'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { issue } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: issue.user.login,
           icon_url: issue.user.avatar_url,
           url: issue.user.html_url
         },
         title: (issue.title || 'Untitled Issue').substr(0, 256),
         url: issue.html_url,
         color: issue.state === 'open' ? 0x238636 : 0xDA3633,
         description: issue.body ? issue.body.substr(0, 2048) : undefined,
         fields: [
           { name: 'Issue', value: `#${issue.number}`, inline: true },
           { name: 'State', value: issue.state, inline: true }
         ],
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Pull Requests
     if: github.event_name == 'pull_request'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { pull_request } = context.payload;
       const action = context.payload.action;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const isMerged = pull_request.merged;
       const effectiveAction = isMerged ? 'merged' : action;

       const colors = { 
         opened: 0x238636,
         closed: 0xDA3633,
         reopened: 0xF0C674,
         review_requested: 0x8957E5,
         merged: 0x8957E5
       };

       const embed = {
         author: {
           name: pull_request.user.login,
           icon_url: pull_request.user.avatar_url,
           url: pull_request.user.html_url
         },
         title: (pull_request.title || 'Untitled PR').substr(0, 256),
         url: pull_request.html_url,
         color: colors[effectiveAction] || 0x6E7681,
         description: pull_request.body ? pull_request.body.substr(0, 2048) : undefined,
         fields: [
           { name: 'PR', value: `#${pull_request.number}`, inline: true },
           { name: 'Status', value: isMerged ? 'merged' : pull_request.state, inline: true },
           { name: 'Branch', value: `${pull_request.head.ref} → ${pull_request.base.ref}`, inline: false }
         ],
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Stars
     if: github.event_name == 'watch'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { sender, repository } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: sender.login,
           icon_url: sender.avatar_url,
           url: sender.html_url
         },
         title: 'Star added',
         url: repository.html_url,
         color: 0xF0C674,
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Forks
     if: github.event_name == 'fork'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { forkee, repository } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: forkee.owner.login,
           icon_url: forkee.owner.avatar_url,
           url: forkee.owner.html_url
         },
         title: 'Repository forked',
         url: forkee.html_url,
         color: 0x6E7681,
         fields: [
           { name: 'Source', value: repository.full_name, inline: true }
         ],
         footer: { 
           text: `${forkee.owner.login}/${forkee.name}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Repository Creation
     if: github.event_name == 'create'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { ref, ref_type, repository, sender } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: sender.login,
           icon_url: sender.avatar_url,
           url: sender.html_url
         },
         title: `${ref_type} created`,
         url: repository.html_url,
         color: 0x238636,
         fields: [
           { name: 'Ref', value: ref, inline: true },
           { name: 'Type', value: ref_type, inline: true }
         ],
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });
