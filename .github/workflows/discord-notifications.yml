name: Discord Notifications

on:
 issues:
  types: [opened, closed, reopened]
 watch:
  types: [started]
 fork:

jobs:
 discord:
  runs-on: ubuntu-latest
  steps:
   - name: Validate Discord Webhook Secret
     run: |
      if [ -z "${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}" ]; then
        echo "❌ Discord webhook URL is not set!"
        echo "Add GH_NOTIFICATIONS_WEBHOOK_URL secret in repository settings"
        exit 1
      fi
      echo "✅ Discord webhook secret is configured"

   - name: Handle Issues
     if: github.event_name == 'issues'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { issue } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: issue.user.login,
           icon_url: issue.user.avatar_url,
           url: issue.user.html_url
         },
         title: (issue.title || 'Untitled Issue').substr(0, 256),
         url: issue.html_url,
         color: issue.state === 'open' ? 0x238636 : 0xDA3633,
         description: issue.body ? issue.body.substr(0, 2048) : undefined,
         fields: [
           { name: 'Issue', value: `#${issue.number}`, inline: true },
           { name: 'State', value: issue.state, inline: true }
         ],
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Stars
     if: github.event_name == 'watch'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { sender, repository } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: sender.login,
           icon_url: sender.avatar_url,
           url: sender.html_url
         },
         title: 'Star added',
         url: repository.html_url,
         color: 0xF0C674,
         footer: { 
           text: `${context.repo.owner}/${context.repo.repo}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });

   - name: Handle Forks
     if: github.event_name == 'fork'
     uses: actions/github-script@v6
     env:
      DISCORD_WEBHOOK: ${{ secrets.GH_NOTIFICATIONS_WEBHOOK_URL }}
     with:
      script: |
       const { forkee, repository } = context.payload;
       const webhookUrl = process.env.DISCORD_WEBHOOK;

       const embed = {
         author: {
           name: forkee.owner.login,
           icon_url: forkee.owner.avatar_url,
           url: forkee.owner.html_url
         },
         title: 'Repository forked',
         url: forkee.html_url,
         color: 0x6E7681,
         fields: [
           { name: 'Source', value: repository.full_name, inline: true }
         ],
         footer: { 
           text: `${forkee.owner.login}/${forkee.name}`
         },
         timestamp: new Date().toISOString(),
       };

       await fetch(webhookUrl, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ embeds: [embed] }),
       });
